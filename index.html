<!doctype html>
<html lang="fr">
<head>
  <!-- Plausible (events + outbound links) -->
  <script defer data-domain="flammeapp.xyz" src="https://plausible.io/js/script.outbound-links.tagged-events.js"></script>

  <meta charset="utf-8" />
  <title>Rencontres</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="format-detection" content="telephone=no" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      /* Base */
      --bg:#ffffff;
      --text:#0f172a;
      --line:#e5e7eb;
      --shadow:0 22px 60px rgba(0,0,0,.14);

      /* Thème OPF (rose + bleu clair) */
      --brand:#F060A0;       /* rose principal (CTA / PASS / titres) */
      --brand-700:#D44F8E;   /* rose foncé pour :active */
      --brand-50:#FFE6F2;    /* rose très clair pour chips/tags */

      --sky:#30B0E0;         /* bleu clair (LIKE) */
      --sky-700:#1E8BB8;     /* bleu foncé pour :active */
      --sky-50:#E9F8FF;      /* bleu très clair (si besoin) */

      /* Le bouton LIKE passe en bleu clair */
      --green: var(--sky);

      /* Fond romantique */
      --bg-overlay:.35;
      --bg-img:url('./images/flamme_bg_desktop.png');

      /* Or (Super-Like) */
      --gold-50:#fff7da; --gold-200:#ffe8a3; --gold-400:#fbd24f; --gold-500:#f5c542; --gold-700:#d19b12;
    }

    html, body { height: 100%; }
    *{box-sizing:border-box}
    html,body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      -webkit-tap-highlight-color:transparent;
    }

    /* BACKGROUND */
    .bg-wrap{ position:fixed; inset:0; z-index:0; overflow:hidden; pointer-events:none; }
    .wrap   { position:relative; z-index:1; }

    .bg-photo{
      position:absolute; inset:0;
      background-image: var(--bg-img);
      background-position:center;
      background-size:cover;
      filter:saturate(1.08) blur(.2px);
      transform:scale(1.03);
    }
    .bg-photo::after{
      content:"";
      position:absolute; inset:0;
      background:linear-gradient(0deg,
        rgba(255,255,255,var(--bg-overlay)),
        rgba(255,255,255,var(--bg-overlay)));
    }
    .bg-bokeh{
      position:absolute; inset:-20% -10%;
      background:
        radial-gradient(600px 300px at 10% 0%, rgba(240,96,160,.12), transparent 60%), /* rose */
        radial-gradient(700px 340px at 90% 100%, rgba(48,176,224,.12), transparent 60%); /* bleu */
      z-index:-1;
    }

    .wrap{max-width:480px; margin:0 auto; min-height:100vh; padding:24px 16px 44px; display:flex; flex-direction:column; gap:16px;}
    @supports(padding:max(0px)){
      .wrap{
        padding-left:max(16px,env(safe-area-inset-left));
        padding-right:max(16px,env(safe-area-inset-right));
        padding-bottom:max(44px,env(safe-area-inset-bottom));
      }
    }

    /* Brand (logo seul, centré) */
    .brand{
      display:flex;
      align-items:center;
      justify-content:center;
      margin-top:6px;
      padding:4px 0 8px;
    }
    .brand img{
      width:140px; height:auto; display:block;
      filter: drop-shadow(0 6px 18px rgba(0,0,0,.08));
    }

    /* Cards */
    .card{background:#fff;border-radius:22px;box-shadow:var(--shadow);border:1px solid #f3f4f6}

    /* Accueil */
    .welcome{padding:22px 20px 22px}
    .label{font-size:16px;color:#374151;font-weight:800;margin:12px 0 10px}
    .row{display:flex;align-items:center;gap:16px}
    .sel,.input{
      appearance:none;-webkit-appearance:none;background:transparent;border:none;outline:none;
      font:inherit;font-weight:900;color:#111827;width:100%;font-size:18px;letter-spacing:.2px
    }
    .field{position:relative;width:100%;padding:16px 0 14px;border-bottom:2px solid var(--line)}
    .field::after{
      content:""; position:absolute; right:0; top:16px; width:22px; height:22px; pointer-events:none;
      background:
        radial-gradient(circle at 50% 45%, #6b7280 0 2px, transparent 3px),
        linear-gradient(135deg, transparent 48%, #9ca3af 50%, transparent 52%) 3px 9px/12px 12px no-repeat;
      opacity:.55;
    }
    .hint{font-size:12px;color:#9ca3af;text-align:center;margin:6px 8px 0}

    /* CTA principal (rose) */
    .cta{
      display:block;width:100%;margin-top:22px;background:var(--brand);color:#fff;border:none;
      border-radius:30px;padding:18px 18px;font-weight:900;font-size:18px;letter-spacing:.2px;
      box-shadow:0 14px 36px rgba(240,96,160,.30)
    }
    .cta:active{transform:scale(.98); background:var(--brand-700);}

    /* Parcours */
    .meta{display:flex;align-items:center;justify-content:space-between;padding:14px 16px 0}
    .count{font-size:14px;color:#6b7280;font-weight:800}
    .persona-box{margin:14px 14px 0;position:relative;border-radius:18px;overflow:hidden;border:1px solid #eee}
    .persona-img{width:100%;height:440px;object-fit:cover;display:block}
    @media(max-width:380px){.persona-img{height:380px}}
    .persona-body{padding:12px 12px 16px}
    .title{font-weight:900;font-size:22px}

    /* Tags style OPF (rose clair) */
    .tags{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 0}
    .tag{
      font-size:12px;padding:6px 10px;border-radius:999px;
      background:var(--brand-50); color:#8a1948; border:1px solid #ffc9e2;
    }

    .desc{margin-top:10px;color:#374151;line-height:1.35}

    /* Actions */
    .actions{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;padding:16px}
    .btn{padding:18px 10px;border-radius:14px;border:none;font-weight:900;font-size:16px}

    /* PASS = rose */
    .btn-pass{background:var(--brand);color:#fff}
    .btn-pass:active{background:var(--brand-700)}

    /* SUPER-LIKE = or */
    .btn-slike{
      background:linear-gradient(180deg, var(--gold-200), var(--gold-500));
      color:#fff; border:1px solid var(--gold-700); text-shadow:0 1px 0 rgba(255,255,255,.35)
    }

    /* LIKE = bleu clair */
    .btn-like{background:var(--sky);color:#fff}
    .btn-like:active{background:var(--sky-700)}
    .btn[disabled]{opacity:.6}

    /* Modals */
    .modal-card.hot{
      /* Halo rosé doux */
      background: radial-gradient(120% 100% at 50% 0, #ffeaf4 0%, #fff 45%);
      border:1px solid #ffd1e6;
    }
    .headline{font-weight:900;font-size:20px;margin:0 0 6px;display:flex;align-items:center;gap:8px}
    .modal-hero{width:100%;border-radius:14px;overflow:hidden;margin:8px 0 12px}
    .pulse{animation:pulse 1.2s infinite}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.03)}100%{transform:scale(1)}}

    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:16px;background:rgba(0,0,0,.45);z-index:50}
    .modal.open{display:flex}
    .modal-card{max-width:460px;width:100%;background:#fff;border-radius:18px;box-shadow:var(--shadow);border:1px solid #eee;padding:22px}
    .modal-actions{display:flex;gap:10px;margin-top:16px;justify-content:flex-end}

    /* Boutons de modal */
    .btn-ghost{background:#fff;border:1px solid #e5e7eb;font-weight:800;padding:10px 14px;border-radius:12px}
    .btn-primary{background:var(--brand);color:#fff;border:none;padding:10px 14px;border-radius:12px;font-weight:900}
    .btn-primary:active{background:var(--brand-700)}
  </style>
</head>
<body>
  <div class="bg-wrap"><div class="bg-photo"></div><div class="bg-bokeh"></div></div>
  <div class="wrap" id="app"></div>

  <script>
    // Charge le script OPF une seule fois
    function loadOPFOnce(){
      if (window.__opf_loaded) return;
      window.__opf_loaded = true;
      var s = document.createElement('script');
      s.async = true;
      s.src = "https://c.opfourpro.net/8/js/script.js?id=Uxrss&source=00055";
      document.head.appendChild(s);
    }
  </script>

  <script>
    /* ==================== Telegram WebApp boot ==================== */
    const tg = window.Telegram?.WebApp || null;
    if (tg) {
      try { tg.ready(); } catch (e) {}
      const expand = () => { try { tg.expand(); } catch (e) {} };
      expand();
      setTimeout(expand, 200);
      window.addEventListener('focus', expand);
    }

    /* ==================== Analytics (Plausible) ==================== */
    (function(){
      const q = [];
      function flush(){
        if (!window.plausible) { setTimeout(flush, 150); return; }
        while(q.length){
          const [name, props] = q.shift();
          try { window.plausible(name, props ? { props } : undefined); } catch(e){}
        }
      }
      window.track = function(name, props){
        if (window.plausible) {
          try { window.plausible(name, props ? { props } : undefined); } catch(e){}
        } else {
          q.push([name, props]);
        }
      };
      setTimeout(flush, 150);
    })();

    function openLinkTG(url){
      if (typeof closeAllModals === 'function') closeAllModals();
      if (tg) {
        if (/^(tg:|https?:\/\/t\.me\/)/i.test(url)) { tg.openTelegramLink(url); return; }
        tg.openLink(url, { try_instant_view: false });
        return;
      }
      window.open(url, "_self");
    }

    /* ==================== CONFIG + PERSIST ==================== */
    const LIKE_LIMIT = 3;
    const SUPERLIKE_LIMIT = 1;
    const MORE_LIKES_URL = "https://go.cm-trk3.com/aff_f?h=Ufqz2x&aff_sub5=telegram&source=dossiertv";
    const MATCH_CHAT_URL = "https://invitation.unlock-moi.net/?source=00055&premium=false";

    // Reset quotidien : nouvelle clé chaque jour -> les profils reviennent le lendemain
    const dayKey   = new Date().toISOString().slice(0,10);
    const likesKey = `flamme_likes_${dayKey}`;
    const superKey = `flamme_super_${dayKey}`;
    const seenKey    = `flamme_seen_${dayKey}`;
    const filtersKey = `flamme_filters`;
    const stepKey    = `flamme_step`;

    function loadSeen(){ try { return new Set(JSON.parse(localStorage.getItem(seenKey) || "[]")); } catch(e){ return new Set(); } }
    function saveSeen(set){ try { localStorage.setItem(seenKey, JSON.stringify([...set])); } catch(e){} }
    function markSeen(id){ const s = loadSeen(); s.add(id); saveSeen(s); }

    function persistFilters(){ try { localStorage.setItem(filtersKey, JSON.stringify(state.filters)); } catch(e){} }
    function restoreFilters(){
      try { const f = JSON.parse(localStorage.getItem(filtersKey) || "null"); if (f) state.filters = f; } catch(e){}
    }
    function persistStep(){ try { localStorage.setItem(stepKey, state.step); } catch(e){} }

    function rebuildPoolFromFilters(){
      const g = state.filters.gender, a1 = state.filters.ageMin, a2 = state.filters.ageMax;
      let pool = PERSONAS.filter(p => (g==="all"||p.gender===g) && p.age>=a1 && p.age<=a2);
      const seen = loadSeen();
      return pool.filter(p => !seen.has(p.id));
    }
    function resumeIfPossible(){
      restoreFilters();
      if (localStorage.getItem(stepKey) === "browse") {
        const pool = rebuildPoolFromFilters();
        if (pool.length) { state.pool = pool; state.step = "browse"; }
      }
    }

    /* ==================== DATA FABRIC ==================== */
    const PERSONA_IMAGES = [
      "./images/photo_1_2025-08-30_17-36-31.jpg","./images/photo_2_2025-08-30_17-36-31.jpg","./images/photo_3_2025-08-30_17-36-31.jpg",
      "./images/photo_4_2025-08-30_17-36-31.jpg","./images/photo_5_2025-08-30_17-36-31.jpg","./images/photo_6_2025-08-30_17-36-31.jpg",
      "./images/photo_7_2025-08-30_17-36-31.jpg","./images/photo_8_2025-08-30_17-36-31.jpg","./images/photo_9_2025-08-30_17-36-31.jpg",
      "./images/photo_10_2025-08-30_17-36-31.jpg","./images/photo_11_2025-08-30_17-36-31.jpg","./images/photo_12_2025-08-30_17-36-31.jpg",
      "./images/photo_13_2025-08-30_17-36-31.jpg","./images/photo_14_2025-08-30_17-36-31.jpg","./images/photo_15_2025-08-30_17-36-31.jpg",
      "./images/photo_16_2025-08-30_17-36-31.jpg","./images/photo_17_2025-08-30_17-36-31.jpg","./images/photo_18_2025-08-30_17-36-31.jpg",
      "./images/photo_19_2025-08-30_17-36-31.jpg","./images/photo_20_2025-08-30_17-36-31.jpg","./images/photo_21_2025-08-30_17-36-31.jpg",
      "./images/photo_22_2025-08-30_17-36-31.jpg","./images/photo_23_2025-08-30_17-36-31.jpg","./images/photo_24_2025-08-30_17-36-31.jpg",
      "./images/photo_25_2025-08-30_17-36-31.jpg","./images/photo_26_2025-08-30_17-36-31.jpg","./images/photo_27_2025-08-30_17-36-31.jpg",
      "./images/photo_28_2025-08-30_17-36-31.jpg","./images/photo_29_2025-08-30_17-36-31.jpg","./images/photo_30_2025-08-30_17-36-31.jpg",
      "./images/photo_31_2025-08-30_17-36-31.jpg","./images/photo_32_2025-08-30_17-36-31.jpg","./images/photo_33_2025-08-30_17-36-31.jpg",
      "./images/photo_34_2025-08-30_17-36-31.jpg","./images/photo_35_2025-08-30_17-36-31.jpg","./images/photo_36_2025-08-30_17-36-31.jpg",
      "./images/photo_37_2025-08-30_17-36-31.jpg","./images/photo_38_2025-08-30_17-36-31.jpg","./images/photo_39_2025-08-30_17-36-31.jpg",
      "./images/photo_40_2025-08-30_17-36-31.jpg","./images/photo_41_2025-08-30_17-36-31.jpg","./images/photo_42_2025-08-30_17-36-31.jpg",
      "./images/photo_43_2025-08-30_17-36-31.jpg","./images/photo_44_2025-08-30_17-36-31.jpg","./images/photo_45_2025-08-30_17-36-31.jpg",
      "./images/photo_46_2025-08-30_17-36-31.jpg","./images/photo_47_2025-08-30_17-36-31.jpg","./images/photo_48_2025-08-30_17-36-31.jpg",
      "./images/photo_49_2025-08-30_17-36-31.jpg","./images/photo_50_2025-08-30_17-36-31.jpg","./images/photo_51_2025-08-30_17-36-31.jpg",
      "./images/photo_52_2025-08-30_17-36-31.jpg","./images/photo_53_2025-08-30_17-36-31.jpg","./images/photo_54_2025-08-30_17-36-31.jpg",
      "./images/photo_55_2025-08-30_17-36-31.jpg","./images/photo_56_2025-08-30_17-36-31.jpg","./images/photo_57_2025-08-30_17-36-31.jpg",
      "./images/photo_58_2025-08-30_17-36-31.jpg","./images/photo_59_2025-08-30_17-36-31.jpg","./images/photo_60_2025-08-30_17-36-31.jpg",
      "./images/photo_61_2025-08-30_17-36-31.jpg","./images/photo_62_2025-08-30_17-36-31.jpg","./images/photo_63_2025-08-30_17-36-31.jpg",
      "./images/photo_64_2025-08-30_17-36-31.jpg","./images/photo_65_2025-08-30_17-36-31.jpg","./images/photo_66_2025-08-30_17-36-31.jpg",
      "./images/photo_67_2025-08-30_17-36-31.jpg","./images/photo_68_2025-08-30_17-36-31.jpg","./images/photo_69_2025-08-30_17-36-31.jpg",
      "./images/photo_70_2025-08-30_17-36-31.jpg","./images/photo_71_2025-08-30_17-36-31.jpg","./images/photo_72_2025-08-30_17-36-31.jpg",
      "./images/photo_73_2025-08-30_17-36-31.jpg","./images/photo_74_2025-08-30_17-36-31.jpg","./images/photo_75_2025-08-30_17-36-31.jpg",
      "./images/photo_76_2025-08-30_17-36-31.jpg","./images/photo_77_2025-08-30_17-36-31.jpg","./images/photo_78_2025-08-30_17-36-31.jpg",
      "./images/photo_79_2025-08-30_17-36-31.jpg","./images/photo_80_2025-08-30_17-36-31.jpg","./images/photo_81_2025-08-30_17-36-31.jpg",
      "./images/photo_82_2025-08-30_17-36-31.jpg","./images/photo_83_2025-08-30_17-36-31.jpg","./images/photo_84_2025-08-30_17-36-31.jpg",
      "./images/photo_85_2025-08-30_17-36-31.jpg","./images/photo_86_2025-08-30_17-36-31.jpg","./images/photo_87_2025-08-30_17-36-31.jpg",
      "./images/photo_88_2025-08-30_17-36-31.jpg","./images/photo_89_2025-08-30_17-36-31.jpg","./images/photo_90_2025-08-30_17-36-31.jpg",
      "./images/photo_91_2025-08-30_17-36-31.jpg","./images/photo_92_2025-08-30_17-36-31.jpg","./images/photo_93_2025-08-30_17-36-31.jpg",
      "./images/photo_94_2025-08-30_17-36-31.jpg","./images/photo_95_2025-08-30_17-36-31.jpg","./images/photo_96_2025-08-30_17-36-31.jpg",
      "./images/photo_97_2025-08-30_17-36-31.jpg","./images/photo_98_2025-08-30_17-36-31.jpg"
    ];

    const FALLBACK_IMAGES = [
      "https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=1600&auto=format&fit=crop",
      "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?q=80&w=1600&auto=format&fit=crop",
      "https://images.unsplash.com/photo-1517841905240-472988babdf9?q=80&w=1600&auto=format&fit=crop",
      "https://images.unsplash.com/photo-1483985988355-763728e1935b?q=80&w=1600&auto=format&fit=crop"
    ];

    const FNAMES = ["Léa","Emma","Chloé","Inès","Sarah","Camille","Luna","Manon","Zoé","Anna","Eva","Lola","Ambre","Jade","Nina","Alicia","Mila","Elisa","Noa","Romane","Léna","Clara","Hana","Aya","Maé","Tara","Maya","Carla","Sofia","Elena","Noémie","Dina","Alya","Malia","Nora","Livia","Sacha","Ava","Iris","Naïma","Salomé","Océane","Maëlle","Justine","Juliette","Pauline","Amandine","Mélissa","Margot","Maud","Charlotte","Élodie","Lucie","Adèle","Roxane","Candice","Anaïs","Laura","Marine","Mélanie","Cassandre","Estelle","Camila","Maïa","Héloïse"];
    const TAGS = ["romantique","douce","fun","cosplay","roleplay","teasing","voyage","musique","ciné","lecture","sport","cuisine","photo","noctambule","respect","danse","yoga","gaming","art","tattoos","animaux","nature","brunch","café","sorties","karaoké","humour","ambitieuse","curieuse","sincère","rando","plage","netflix","streetwear","festivals","bien-être","jeux de société","énergie positive","minimaliste","foodie"];
    const DESCS = ["Curieuse et positive. Ici pour un bon feeling ✨.","Fan de séries et de balades le soir.","Team respect & limites claires. On rigole, on chill.","Cosplay & papotes tardives. No pressure.","J’adore la bonne bouffe et les city-breaks.","Plutôt douce, j’aime les attentions simples.","Un peu taquine. Si la vibe passe, on voit 😉.","Musique, café et longues discussions.","Toujours partante pour un resto ou un walk.","Rires faciles, zéro drama.","Sport le matin, chill le soir.","Grande lectrice, petit cœur fondant.","Voyages improvisés et photos souvenirs.","Ambitieuse mais terre-à-terre.","Karaoké queen le vendredi soir.","Team brunch du dimanche.","Danse, bonne humeur, bonne vibe.","Créative, un brin rêveuse.","Nature & city breaks, j’aime les deux.","Netflix + plaid = bonheur.","Toujours respectueuse, toujours sincère.","Un message bienveillant fait ma journée.","Petite dose de teasing, beaucoup de respect.","Cosy nights > grosses soirées.","J’adore les chiens et les couchers de soleil.","Partenaire de jeux (de société) recherchée.","J’écris parfois, je ris souvent.","Trop de playlists, jamais assez de concerts.","Gourmande et curieuse de tout.","On garde ça simple et fun.","Discrète mais pas timide.","Je préfère la qualité à la quantité.","Toujours ok pour découvrir un nouveau café.","Roleplay soft, vibe chill, esprit ouvert."];

    const rnd = (a,b)=> Math.floor(Math.random()*(b-a+1))+a;
    const pick = arr => arr[rnd(0,arr.length-1)];
    const pickMany = (arr,n)=>{ const c=[...arr]; const out=[]; while(n-- && c.length){ out.push(c.splice(rnd(0,c.length-1),1)[0]); } return out; };

    const PERSONA_CACHE_KEY = "flamme_personas_v1_" + (PERSONA_IMAGES.join("|").length) + "_" + PERSONA_IMAGES.length;

    function buildPersonasFromImages(urls){
      const shuffled=[...urls].sort(()=>Math.random()-.5);
      return shuffled.map((src,i)=>({
        id:`img_${i+1}`,
        name: pick(FNAMES),
        gender: "women",
        age: rnd(18,32),
        tags: pickMany(TAGS, 3),
        desc: pick(DESCS),
        photos: [src]
      }));
    }
    function loadOrGeneratePersonas(){
      try{
        const raw = localStorage.getItem(PERSONA_CACHE_KEY);
        if(raw){ const parsed = JSON.parse(raw); if(Array.isArray(parsed) && parsed.length) return parsed; }
      }catch(e){}
      const base = PERSONA_IMAGES.length ? PERSONA_IMAGES : FALLBACK_IMAGES;
      const generated = buildPersonasFromImages(base);
      try{ localStorage.setItem(PERSONA_CACHE_KEY, JSON.stringify(generated)); }catch(e){}
      return generated;
    }

    /* ==================== STATE ==================== */
    const state = {
      step:"landing",
      filters:{ gender:"women", ageMin:18, ageMax:60, city:"" },
      pool:[], idx:0,
      likesLeft:LIKE_LIMIT, superLeft:SUPERLIKE_LIMIT,
      busy:false,
    };

    let PERSONAS = loadOrGeneratePersonas();
    resumeIfPossible(); // reprise si on était en "browse"

    /* ==================== DOM HELPERS ==================== */
    const $ = s => document.querySelector(s);
    const el = (tag, props={}, children=[])=>{
      const n=document.createElement(tag);
      Object.entries(props).forEach(([k,v])=>{
        if(k==="class") n.className=v;
        else if(k==="text") n.textContent=v;
        else if(k.startsWith("on") && typeof v==="function") n.addEventListener(k.slice(2).toLowerCase(), v, {passive:true});
        else n.setAttribute(k,v);
      });
      (Array.isArray(children)?children:[children]).filter(Boolean).forEach(c=>n.appendChild(c));
      return n;
    };

    /* ==================== BRAND HEADER (logo seul) ==================== */
    function renderBrand(){
      const wrap = el("div",{class:"brand"});
      const logo = el("img", { src:"./images/1756677245823-85225351.png", alt:"Logo" });
      wrap.appendChild(logo);
      return wrap;
    }

    /* ==================== RENDER ROOT ==================== */
    function render(){
      const root = $("#app"); root.innerHTML="";
      root.appendChild(renderBrand());
      if(state.step==="landing") root.appendChild(renderLanding());
      else root.appendChild(renderBrowse());
      ensureModals(root);
      persistStep();
    }

    /* ==================== LANDING ==================== */
    function renderLanding(){
      const card = el("div",{class:"card"}), box  = el("div",{class:"welcome"});

      // Que recherchez-vous ?
      box.appendChild(el("div",{class:"label",text:"Que recherchez-vous ?"}));
      const genderSel = el("select",{id:"selGender",class:"sel"});
      [["women","Femme"],["men","Homme"],["all","Tout"]].forEach(([v,l])=> genderSel.appendChild(el("option",{value:v,text:l})));
      genderSel.value = state.filters.gender;
      genderSel.onchange = ()=> state.filters.gender = genderSel.value;
      box.appendChild(el("div",{class:"field"}, genderSel));

      // Âge min / max
      box.appendChild(el("div",{class:"label",text:"Âge"}));
      const row = el("div",{class:"row"});
      const ageMinSel = el("select",{class:"sel"}), ageMaxSel = el("select",{class:"sel"});
      for(let a=18;a<=60;a++){ ageMinSel.appendChild(el("option",{value:a,text:a})); ageMaxSel.appendChild(el("option",{value:a,text:a})); }
      ageMinSel.value = state.filters.ageMin; ageMaxSel.value = state.filters.ageMax;
      ageMinSel.onchange = ()=>{
        state.filters.ageMin = parseInt(ageMinSel.value,10);
        if(state.filters.ageMin > state.filters.ageMax){ state.filters.ageMax = state.filters.ageMin; ageMaxSel.value = String(state.filters.ageMax); }
      };
      ageMaxSel.onchange = ()=>{
        state.filters.ageMax = parseInt(ageMaxSel.value,10);
        if(state.filters.ageMax < state.filters.ageMin){ state.filters.ageMin = state.filters.ageMax; ageMinSel.value = String(state.filters.ageMin); }
      };
      row.appendChild(el("div",{style:"flex:1"},[ el("div",{class:"label",text:"Entre"}), el("div",{class:"field"}, ageMinSel) ]));
      row.appendChild(el("div",{style:"flex:1"},[ el("div",{class:"label",text:"et"}),     el("div",{class:"field"}, ageMaxSel) ]));
      box.appendChild(row);

      // Ville (optionnel)
      box.appendChild(el("div",{class:"label",text:"Dans quelle ville habitez-vous ?"}));
      const city = el("input",{class:"input",type:"text",placeholder:"Ville (optionnel)"});
      city.value = state.filters.city; city.oninput = ()=> state.filters.city = city.value.trim();
      box.appendChild(el("div",{class:"field"}, city));

      const cta = el("button",{class:"cta",text:"Voir les célibataires", onclick:()=>{
        persistFilters();
        state.pool = rebuildPoolFromFilters();
        if(!state.pool.length){ alert("Aucun profil avec ces filtres pour le moment. Essaie d’élargir ✨"); return; }
        state.idx=0;
        state.likesLeft = parseInt(localStorage.getItem(likesKey) ?? LIKE_LIMIT, 10);
        state.superLeft = parseInt(localStorage.getItem(superKey) ?? SUPERLIKE_LIMIT, 10);
        track('filters', { gender: state.filters.gender, ageMin: state.filters.ageMin, ageMax: state.filters.ageMax, city: state.filters.city });
        state.step="browse"; render(); openRulesModal();
      }});
      box.appendChild(cta);
      box.appendChild(el("p",{class:"hint",text:"3 likes + 1 super-like par compte non créé."}));

      card.appendChild(box);
      return card;
    }

    /* ==================== BROWSE ==================== */
    function renderBrowse(){
      const card = el("div",{class:"card"});

      // Empty state si plus de profils
      if (!state.pool.length){
        const box = el("div",{class:"welcome"});
        box.appendChild(el("div",{class:"label",text:"Plus de profils pour l’instant 💫"}));
        box.appendChild(el("p",{class:"hint",text:"Aucun nouveau profil avec ces filtres aujourd’hui."}));
        box.appendChild(el("button",{class:"cta",text:"Modifier les filtres", onclick:()=>{ state.step="landing"; render(); }}));
        card.appendChild(box);
        return card;
      }

      const meta = el("div",{class:"meta"},[
        el("div",{class:"count",text:`Likes: ${state.likesLeft} • Super-like: ${state.superLeft}`}),
        el("div",{class:"count",text:`${state.filters.city?state.filters.city+" • ":""}${labelGender(state.filters.gender)} • ${state.filters.ageMin}-${state.filters.ageMax} ans`})
      ]);
      card.appendChild(meta);

      const p = currentPersona();
      const mediaWrap = el("div",{class:"persona-box"});
      mediaWrap.appendChild(el("img",{class:"persona-img",src:p.photos[0],alt:p.name,loading:"eager"}));
      card.appendChild(mediaWrap);

      const body = el("div",{class:"persona-body"});
      body.appendChild(el("div",{class:"title",text:`${p.name} • ${p.age}`}));
      body.appendChild(el("div",{class:"tags"}, p.tags.map(t=>el("span",{class:"tag",text:t}))));
      body.appendChild(el("div",{class:"desc",text:p.desc}));
      card.appendChild(body);

      const actions = el("div",{class:"actions"});
      const bPass  = el("button",{class:"btn btn-pass", text:"PASS", onclick:()=>!state.busy && doPass()});
      const bSLike = el("button",{class:"btn btn-slike",text:"SUPER LIKE", onclick:()=>!state.busy && superLike()});
      const bLike  = el("button",{class:"btn btn-like", text:"LIKE", onclick:()=>!state.busy && like()});
      actions.append(bPass,bSLike,bLike);
      card.appendChild(actions);

      return card;
    }

    /* ==================== LOGIC ==================== */
    function labelGender(g){ return g==="women"?"Femmes":g==="men"?"Hommes":"Tous"; }
    function currentPersona(){ return state.pool[state.idx % state.pool.length]; }
    function bumpGuard(){ state.busy=true; setTimeout(()=>state.busy=false,140); }

    function showNextAfterRemoval(){
      bumpGuard();
      if (!state.pool.length){ render(); return; }
      if (state.idx >= state.pool.length) state.idx = 0;
      track('profiles_seen');
      render();
    }

    function doPass(){
      const p = currentPersona();
      markSeen(p.id);
      track('pass', { persona_id: p.id });
      state.pool.splice(state.idx % state.pool.length, 1);
      showNextAfterRemoval();
    }

    function like(){
      const p = currentPersona();
      if(state.likesLeft<=0){ openNoLikesModal(); track('like_blocked'); return; }
      state.likesLeft -= 1; localStorage.setItem(likesKey, state.likesLeft);
      markSeen(p.id);
      track('like', { persona_id: p.id });
      state.pool.splice(state.idx % state.pool.length, 1);
      showNextAfterRemoval();
    }

    function superLike(){
      const p = currentPersona();
      if (state.superLeft > 0) {
        state.superLeft -= 1;
        localStorage.setItem(superKey, state.superLeft);
        track('super_like', { persona_id: p.id });
        openMatchModal(p);
        markSeen(p.id);
        state.pool.splice(state.idx % state.pool.length, 1);
        showNextAfterRemoval();
        track('match', { persona_id: p.id });
      } else {
        track('super_like_reopen', { persona_id: p.id });
        openSuperLikeDoneModal();
      }
    }

    /* ==================== MODALS ==================== */
    function ensureModals(root){
      root.appendChild(el("div",{class:"modal",id:"m_rules"},
        el("div",{class:"modal-card hot"},[
          el("div",{class:"headline",text:"🔥 Rappel rapide"}),
          el("div",{text:"Tu démarres avec 3 Likes ❤️ et 1 Super-Like ✨. Tu pourras créer ton compte plus tard pour obtenir des likes bonus immédiatement."}),
          el("div",{class:"modal-actions"},[
            el("button",{class:"btn-ghost",text:"D’accord",onclick:()=>closeModal("#m_rules")})
          ])
        ])
      ));

      root.appendChild(el("div",{class:"modal",id:"m_nolikes"},
        el("div",{class:"modal-card hot"},[
          el("div",{class:"headline",text:"💔 Plus de likes"}),
          el("div",{text:"Tu as épuisé tes 3 likes. Crée ton compte maintenant pour débloquer des likes supplémentaires."}),
          el("div",{class:"modal-actions"},[
            el("a",{href:"#",class:"btn-primary pulse",text:"S’inscrire et obtenir + de likes",
              onclick:(e)=>{e.preventDefault(); openMoreLikes(); }})
          ])
        ])
      ));
      root.appendChild(el("div",{class:"modal",id:"m_superdone"},
        el("div",{class:"modal-card hot"},[
          el("div",{class:"headline",text:"✨ Super-Like déjà utilisé"}),
          el("div",{text:"Tu as déjà utilisé ton Super-Like du jour et obtenu ton match. Pour discuter avec lui, clique ci-dessous."}),
          el("div",{class:"modal-actions"},[
            el("a",{href:"#",class:"btn-primary pulse",text:"Discuter maintenant",
              onclick:(e)=>{e.preventDefault(); openChat(); }}),
            el("button",{class:"btn-ghost",text:"Fermer",onclick:()=>closeModal("#m_superdone")})
          ])
        ])
      ));

      root.appendChild(el("div",{class:"modal",id:"m_match"},
        el("div",{class:"modal-card hot"},[
          el("div",{class:"headline",text:"🎉 Match obtenu !"}),
          el("div",{class:"modal-hero"},
            el("img",{id:"matchImg",src:"",alt:"Match",style:"width:100%;display:block"})
          ),
          el("div",{style:"font-weight:800;margin-top:2px"},[
            document.createTextNode("Vous avez matché avec "),
            el("span",{id:"matchName",text:"cette personne"}),
            document.createTextNode(" 💞")
          ]),
          el("div",{class:"modal-actions"},[
            el("a",{href:"#",class:"btn-primary pulse",text:"Discuter maintenant",
              onclick:(e)=>{e.preventDefault(); openChat(); }})
          ])
        ])
      ));
    }

    function openModal(sel){ const m=$(sel); if(m) m.classList.add("open"); }
    function closeModal(sel){ const m=$(sel); if(m) m.classList.remove("open"); }
    function closeAllModals(){ document.querySelectorAll('.modal.open').forEach(m=>m.classList.remove('open')); }
    function openRulesModal(){ openModal("#m_rules"); }
    function openNoLikesModal(){ openModal("#m_nolikes"); }

    function openMatchModal(p){
      const img = $("#matchImg"); const nm = $("#matchName");
      if (img) img.src = p.photos[0];
      if (nm)  nm.textContent = p.name;
      openModal("#m_match");
    }

    // CTA wrappers avec tracking (événements Plausible)
    function openMoreLikes(){ track('cta_more'); openLinkTG(MORE_LIKES_URL); }
    function openChat(){
      loadOPFOnce();            // ⬅️ injecte le script quand l’utilisateur clique
      track('cta_chat');
      //openLinkTG(MATCH_CHAT_URL);
    }


    /* ============ BOOT ============ */
    render();
    // Event "open" au boot
    setTimeout(()=>track('open'), 300);
  </script>
</body>
</html>
