<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Flamme ‚Äî Rencontres</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="format-detection" content="telephone=no" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#ffffff; --brand:#e0193f; --brand-700:#c81639; --brand-50:#fff1f4;
      --text:#0f172a; --line:#e5e7eb; --shadow:0 22px 60px rgba(0,0,0,.14);
      --green:#16a34a;

      /* FOND romantique */
      --bg-overlay:.35;
      --bg-img:url('./images/mayur-gala-2PODhmrvLik-unsplash.jpg');

      /* Or (Super-Like) */
      --gold-50:#fff7da; --gold-200:#ffe8a3; --gold-400:#fbd24f; --gold-500:#f5c542; --gold-700:#d19b12;
    }

    *{box-sizing:border-box}
    html,body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      -webkit-tap-highlight-color:transparent;
    }

    /* BACKGROUND */
    .bg-wrap{ position:fixed; inset:0; z-index:0; overflow:hidden; pointer-events:none; }
    .wrap   { position:relative; z-index:1; }

    .bg-photo{
      position:absolute; inset:0;
      background-image: var(--bg-img);
      background-position:center;
      background-size:cover;
      filter:saturate(1.08) blur(.2px);
      transform:scale(1.03);
    }
    .bg-photo::after{
      content:"";
      position:absolute; inset:0;
      background:linear-gradient(0deg,
        rgba(255,255,255,var(--bg-overlay)),
        rgba(255,255,255,var(--bg-overlay)));
    }
    .bg-bokeh{
      position:absolute; inset:-20% -10%;
      background:
        radial-gradient(600px 300px at 10% 0%, rgba(224,25,63,.09), transparent 60%),
        radial-gradient(700px 340px at 90% 100%, rgba(224,25,63,.08), transparent 60%);
      z-index:-1;
    }

    .wrap{max-width:480px; margin:0 auto; min-height:100vh; padding:24px 16px 44px; display:flex; flex-direction:column; gap:16px;}
    @supports(padding:max(0px)){
      .wrap{ padding-left:max(16px,env(safe-area-inset-left));
             padding-right:max(16px,env(safe-area-inset-right));
             padding-bottom:max(44px,env(safe-area-inset-bottom)); }
    }

    /* Brand + logo */
    .brand{display:flex;align-items:center;justify-content:center;gap:12px;margin-top:6px}
    .brand h1{margin:0;font-size:28px;font-weight:900;letter-spacing:.2px}

    /* Bouton admin flottant */
    .fab-admin{
      position:fixed; right:16px; bottom:16px; z-index:60;
      background:#fff; border:1px solid #e5e7eb; border-radius:999px;
      padding:10px 14px; box-shadow:var(--shadow); font-weight:900; cursor:pointer;
    }

    /* Cards */
    .card{background:#fff;border-radius:22px;box-shadow:var(--shadow);border:1px solid #f3f4f6}

    /* Accueil */
    .welcome{padding:22px 20px 22px}
    .label{font-size:16px;color:#374151;font-weight:800;margin:12px 0 10px}
    .row{display:flex;align-items:center;gap:16px}
    .sel,.input{
      appearance:none;-webkit-appearance:none;background:transparent;border:none;outline:none;
      font:inherit;font-weight:900;color:#111827;width:100%;font-size:18px;letter-spacing:.2px
    }
    .field{position:relative;width:100%;padding:16px 0 14px;border-bottom:2px solid var(--line)}
    .field::after{
      content:""; position:absolute; right:0; top:16px; width:22px; height:22px; pointer-events:none;
      background:
        radial-gradient(circle at 50% 45%, #6b7280 0 2px, transparent 3px),
        linear-gradient(135deg, transparent 48%, #9ca3af 50%, transparent 52%) 3px 9px/12px 12px no-repeat;
      opacity:.55;
    }
    .hint{font-size:12px;color:#9ca3af;text-align:center;margin:6px 8px 0}
    .cta{display:block;width:100%;margin-top:22px;background:var(--brand);color:#fff;border:none;
      border-radius:30px;padding:18px 18px;font-weight:900;font-size:18px;letter-spacing:.2px;box-shadow:0 14px 36px rgba(224,25,63,.32)}
    .cta:active{transform:scale(.98)}

    /* Parcours */
    .meta{display:flex;align-items:center;justify-content:space-between;padding:14px 16px 0}
    .count{font-size:14px;color:#6b7280;font-weight:800}
    .persona-box{margin:14px 14px 0;position:relative;border-radius:18px;overflow:hidden;border:1px solid #eee}
    .persona-img{width:100%;height:440px;object-fit:cover;display:block}
    @media(max-width:380px){.persona-img{height:380px}}
    .persona-body{padding:12px 12px 16px}
    .title{font-weight:900;font-size:22px}
    .tags{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 0}
    .tag{font-size:12px;padding:6px 10px;border-radius:999px;background:var(--brand-50);color:#7f1d1d;border:1px solid #ffd1dc}
    .desc{margin-top:10px;color:#374151;line-height:1.35}

    .actions{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;padding:16px}
    .btn{padding:18px 10px;border-radius:14px;border:none;font-weight:900;font-size:16px}
    .btn-pass{background:var(--brand);color:#fff}
    .btn-slike{
      background:linear-gradient(180deg, var(--gold-200), var(--gold-500));
      color:#fff; border:1px solid var(--gold-700); text-shadow:0 1px 0 rgba(255,255,255,.35)
    }
    .btn-like{background:var(--green);color:#fff}
    .btn[disabled]{opacity:.6}

    /* Modals */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:16px;background:rgba(0,0,0,.45);z-index:50}
    .modal.open{display:flex}
    .modal-card{max-width:460px;width:100%;background:#fff;border-radius:18px;box-shadow:var(--shadow);border:1px solid #eee;padding:22px}
    .modal-card.hot{background: radial-gradient(120% 100% at 50% 0, #ffe4ea 0%, #fff 45%);border:1px solid #ffd1dc;}
    .headline{font-weight:900;font-size:20px;margin:0 0 6px;display:flex;align-items:center;gap:8px}
    .modal-hero{width:100%;border-radius:14px;overflow:hidden;margin:8px 0 12px}
    .modal-actions{display:flex;gap:10px;margin-top:16px;justify-content:flex-end}
    .btn-ghost{background:#fff;border:1px solid #e5e7eb;font-weight:800;padding:10px 14px;border-radius:12px}
    .btn-primary{background:var(--brand);color:#fff;border:none;padding:10px 14px;border-radius:12px;font-weight:900}
    .pulse{animation:pulse 1.2s infinite}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.03)}100%{transform:scale(1)}}
    .admin-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    .stat{background:#fff;border:1px solid #eee;border-radius:12px;padding:10px 12px;font-weight:800}
    .stat small{display:block;color:#6b7280;font-weight:700}
  </style>
</head>
<body>
  <div class="bg-wrap"><div class="bg-photo"></div><div class="bg-bokeh"></div></div>
  <div class="wrap" id="app"></div>
  <button class="fab-admin" id="btnAdmin" title="Panneau admin">‚öôÔ∏è</button>

  <script>
    /* ==================== Stats locales (localStorage) ==================== */
    const STATS_KEY = "flamme_stats_v1";
    const todayStr = ()=> new Date().toISOString().slice(0,10);

    function loadStats(){
      try{ const raw = localStorage.getItem(STATS_KEY); if(raw) return JSON.parse(raw); }catch(e){}
      return {
        sessions: 0,                       // nombre de sessions (sur cet appareil)
        totals: { opens:0, profiles_seen:0, pass:0, like:0, super_like:0, match:0, cta_more:0, cta_chat:0 },
        byDay: {},                         // { "YYYY-MM-DD": { ...counters } }
        events: []                         // [{ts,type,data}], limit√© √† 1000
      };
    }
    function saveStats(s){ try{ localStorage.setItem(STATS_KEY, JSON.stringify(s)); }catch(e){} }
    function incStat(type, data={}){
      const s = loadStats();
      const d = todayStr();
      s.totals[type] = (s.totals[type]||0) + 1;
      s.byDay[d] = s.byDay[d] || {};
      s.byDay[d][type] = (s.byDay[d][type]||0) + 1;
      s.events.push({ ts: new Date().toISOString(), type, data });
      if (s.events.length > 1000) s.events.splice(0, s.events.length - 1000);
      saveStats(s);
      return s;
    }
    function addSession(){
      const s = loadStats();
      s.sessions += 1;
      const d = todayStr();
      s.byDay[d] = s.byDay[d] || {};
      s.byDay[d].sessions = (s.byDay[d].sessions||0) + 1;
      saveStats(s);
      return s;
    }
    function exportCSV(){
      const s = loadStats();
      const header = "ts,type,data\n";
      const lines = s.events.map(e=>{
        const safe = JSON.stringify(e.data || {}).replaceAll('"','""');
        return `${e.ts},${e.type},"${safe}"`;
      });
      const blob = new Blob([header + lines.join("\n")], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      triggerDownload(url, `flamme_events_${todayStr()}.csv`);
    }
    function exportJSON(){
      const s = loadStats();
      const blob = new Blob([JSON.stringify(s,null,2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      triggerDownload(url, `flamme_stats_${todayStr()}.json`);
    }
    function triggerDownload(url, filename){
      const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=> URL.revokeObjectURL(url), 1500);
    }
    function resetStats(){
      localStorage.removeItem(STATS_KEY);
      renderAdmin(); // refresh UI si ouverte
    }

    /* ==================== Config app ==================== */
    const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
    if (tg){ try{ tg.ready(); tg.expand(); }catch(e){} }

    const BRAND = "Flamme";
    const LIKE_LIMIT = 3;
    const SUPERLIKE_LIMIT = 1;
    const MORE_LIKES_URL = "https://exemple.com/obtenir-plus-de-likes"; // remplace si besoin
    const MATCH_CHAT_URL = "https://exemple.com/parler";                 // remplace si besoin
    const dayKey = new Date().toISOString().slice(0,10);
    const likesKey = `flamme_likes_${dayKey}`;
    const superKey = `flamme_super_${dayKey}`;

    // Session (compte local)
    if (!sessionStorage.getItem("flamme_session_counted")){
      sessionStorage.setItem("flamme_session_counted","1");
      addSession();
      incStat("opens");
    }

    /* ==================== Images / faux profils ==================== */
    const PERSONA_IMAGES = [
      "./images/photo_1_2025-08-30_17-36-31.jpg","./images/photo_2_2025-08-30_17-36-31.jpg","./images/photo_3_2025-08-30_17-36-31.jpg",
      "./images/photo_4_2025-08-30_17-36-31.jpg","./images/photo_5_2025-08-30_17-36-31.jpg","./images/photo_6_2025-08-30_17-36-31.jpg",
      "./images/photo_7_2025-08-30_17-36-31.jpg","./images/photo_8_2025-08-30_17-36-31.jpg","./images/photo_9_2025-08-30_17-36-31.jpg",
      "./images/photo_10_2025-08-30_17-36-31.jpg","./images/photo_11_2025-08-30_17-36-31.jpg","./images/photo_12_2025-08-30_17-36-31.jpg",
      "./images/photo_13_2025-08-30_17-36-31.jpg","./images/photo_14_2025-08-30_17-36-31.jpg","./images/photo_15_2025-08-30_17-36-31.jpg",
      "./images/photo_16_2025-08-30_17-36-31.jpg","./images/photo_17_2025-08-30_17-36-31.jpg","./images/photo_18_2025-08-30_17-36-31.jpg",
      "./images/photo_19_2025-08-30_17-36-31.jpg","./images/photo_20_2025-08-30_17-36-31.jpg","./images/photo_21_2025-08-30_17-36-31.jpg",
      "./images/photo_22_2025-08-30_17-36-31.jpg","./images/photo_23_2025-08-30_17-36-31.jpg","./images/photo_24_2025-08-30_17-36-31.jpg",
      "./images/photo_25_2025-08-30_17-36-31.jpg","./images/photo_26_2025-08-30_17-36-31.jpg","./images/photo_27_2025-08-30_17-36-31.jpg",
      "./images/photo_28_2025-08-30_17-36-31.jpg","./images/photo_29_2025-08-30_17-36-31.jpg","./images/photo_30_2025-08-30_17-36-31.jpg",
      "./images/photo_31_2025-08-30_17-36-31.jpg","./images/photo_32_2025-08-30_17-36-31.jpg","./images/photo_33_2025-08-30_17-36-31.jpg",
      "./images/photo_34_2025-08-30_17-36-31.jpg","./images/photo_35_2025-08-30_17-36-31.jpg","./images/photo_36_2025-08-30_17-36-31.jpg",
      "./images/photo_37_2025-08-30_17-36-31.jpg","./images/photo_38_2025-08-30_17-36-31.jpg","./images/photo_39_2025-08-30_17-36-31.jpg",
      "./images/photo_40_2025-08-30_17-36-31.jpg","./images/photo_41_2025-08-30_17-36-31.jpg","./images/photo_42_2025-08-30_17-36-31.jpg",
      "./images/photo_43_2025-08-30_17-36-31.jpg","./images/photo_44_2025-08-30_17-36-31.jpg","./images/photo_45_2025-08-30_17-36-31.jpg",
      "./images/photo_46_2025-08-30_17-36-31.jpg","./images/photo_47_2025-08-30_17-36-31.jpg","./images/photo_48_2025-08-30_17-36-31.jpg",
      "./images/photo_49_2025-08-30_17-36-31.jpg","./images/photo_50_2025-08-30_17-36-31.jpg","./images/photo_51_2025-08-30_17-36-31.jpg",
      "./images/photo_52_2025-08-30_17-36-31.jpg","./images/photo_53_2025-08-30_17-36-31.jpg","./images/photo_54_2025-08-30_17-36-31.jpg",
      "./images/photo_55_2025-08-30_17-36-31.jpg","./images/photo_56_2025-08-30_17-36-31.jpg","./images/photo_57_2025-08-30_17-36-31.jpg",
      "./images/photo_58_2025-08-30_17-36-31.jpg","./images/photo_59_2025-08-30_17-36-31.jpg","./images/photo_60_2025-08-30_17-36-31.jpg",
      "./images/photo_61_2025-08-30_17-36-31.jpg","./images/photo_62_2025-08-30_17-36-31.jpg","./images/photo_63_2025-08-30_17-36-31.jpg",
      "./images/photo_64_2025-08-30_17-36-31.jpg","./images/photo_65_2025-08-30_17-36-31.jpg","./images/photo_66_2025-08-30_17-36-31.jpg",
      "./images/photo_67_2025-08-30_17-36-31.jpg","./images/photo_68_2025-08-30_17-36-31.jpg","./images/photo_69_2025-08-30_17-36-31.jpg",
      "./images/photo_70_2025-08-30_17-36-31.jpg","./images/photo_71_2025-08-30_17-36-31.jpg","./images/photo_72_2025-08-30_17-36-31.jpg",
      "./images/photo_73_2025-08-30_17-36-31.jpg","./images/photo_74_2025-08-30_17-36-31.jpg","./images/photo_75_2025-08-30_17-36-31.jpg",
      "./images/photo_76_2025-08-30_17-36-31.jpg","./images/photo_77_2025-08-30_17-36-31.jpg","./images/photo_78_2025-08-30_17-36-31.jpg",
      "./images/photo_79_2025-08-30_17-36-31.jpg","./images/photo_80_2025-08-30_17-36-31.jpg","./images/photo_81_2025-08-30_17-36-31.jpg",
      "./images/photo_82_2025-08-30_17-36-31.jpg","./images/photo_83_2025-08-30_17-36-31.jpg","./images/photo_84_2025-08-30_17-36-31.jpg",
      "./images/photo_85_2025-08-30_17-36-31.jpg","./images/photo_86_2025-08-30_17-36-31.jpg","./images/photo_87_2025-08-30_17-36-31.jpg",
      "./images/photo_88_2025-08-30_17-36-31.jpg","./images/photo_89_2025-08-30_17-36-31.jpg","./images/photo_90_2025-08-30_17-36-31.jpg",
      "./images/photo_91_2025-08-30_17-36-31.jpg","./images/photo_92_2025-08-30_17-36-31.jpg","./images/photo_93_2025-08-30_17-36-31.jpg",
      "./images/photo_94_2025-08-30_17-36-31.jpg","./images/photo_95_2025-08-30_17-36-31.jpg","./images/photo_96_2025-08-30_17-36-31.jpg",
      "./images/photo_97_2025-08-30_17-36-31.jpg","./images/photo_98_2025-08-30_17-36-31.jpg"
    ];
    const FALLBACK_IMAGES = [
      "https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=1600&auto=format&fit=crop",
      "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?q=80&w=1600&auto=format&fit=crop",
      "https://images.unsplash.com/photo-1517841905240-472988babdf9?q=80&w=1600&auto=format&fit=crop",
      "https://images.unsplash.com/photo-1483985988355-763728e1935b?q=80&w=1600&auto=format&fit=crop"
    ];

    /* ==================== Helpers profils ==================== */
    const FNAMES = ["L√©a","Emma","Chlo√©","In√®s","Sarah","Camille","Luna","Manon","Zo√©","Anna","Eva","Lola","Ambre","Jade","Nina","Alicia","Mila","Elisa","Noa","Romane","L√©na","Clara","Hana","Aya","Ma√©","Tara","Maya","Carla","Sofia","Elena","No√©mie","Dina","Alya","Malia","Nora","Livia","Sacha","Ava","Iris","Na√Øma","Salom√©","Oc√©ane","Ma√´lle","Justine","Juliette","Pauline","Amandine","M√©lissa","Margot","Maud","Charlotte","√âlodie","Lucie","Ad√®le","Roxane","Candice","Ana√Øs","Laura","Marine","M√©lanie","Cassandre","Estelle","Camila","Ma√Øa","H√©lo√Øse"];
    const TAGS = ["romantique","douce","fun","cosplay","roleplay","teasing","voyage","musique","cin√©","lecture","sport","cuisine","photo","noctambule","respect","danse","yoga","gaming","art","tattoos","animaux","nature","brunch","caf√©","sorties","karaok√©","humour","ambitieuse","curieuse","sinc√®re","rando","plage","netflix","streetwear","festivals","bien-√™tre","jeux de soci√©t√©","√©nergie positive","minimaliste","foodie"];
    const DESCS = ["Curieuse et positive. Ici pour un bon feeling ‚ú®.","Fan de s√©ries et de balades le soir.","Team respect & limites claires. On rigole, on chill.","Cosplay & papotes tardives. No pressure.","J‚Äôadore la bonne bouffe et les city-breaks.","Plut√¥t douce, j‚Äôaime les attentions simples.","Un peu taquine. Si la vibe passe, on voit üòâ.","Musique, caf√© et longues discussions.","Toujours partante pour un resto ou un walk.","Rires faciles, z√©ro drama.","Sport le matin, chill le soir.","Grande lectrice, petit c≈ìur fondant.","Voyages improvis√©s et photos souvenirs.","Ambitieuse mais terre-√†-terre.","Karaok√© queen le vendredi soir.","Team brunch du dimanche.","Danse, bonne humeur, bonne vibe.","Cr√©ative, un brin r√™veuse.","Nature & city breaks, j‚Äôaime les deux.","Netflix + plaid = bonheur.","Toujours respectueuse, toujours sinc√®re.","Un message bienveillant fait ma journ√©e.","Petite dose de teasing, beaucoup de respect.","Cosy nights > grosses soir√©es.","J‚Äôadore les chiens et les couchers de soleil.","Partenaire de jeux (de soci√©t√©) recherch√©e.","J‚Äô√©cris parfois, je ris souvent.","Trop de playlists, jamais assez de concerts.","Gourmande et curieuse de tout.","On garde √ßa simple et fun.","Discr√®te mais pas timide.","Je pr√©f√®re la qualit√© √† la quantit√©.","Toujours ok pour d√©couvrir un nouveau caf√©.","Roleplay soft, vibe chill, esprit ouvert."];

    const rnd=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
    const pick=arr=>arr[rnd(0,arr.length-1)];
    const pickMany=(arr,n)=>{const c=[...arr],out=[];while(n--&&c.length){out.push(c.splice(rnd(0,c.length-1),1)[0]);}return out;};

    const PERSONA_CACHE_KEY="flamme_personas_v1_"+(PERSONA_IMAGES.join("|").length)+"_"+PERSONA_IMAGES.length;
    function buildPersonasFromImages(urls){
      const shuffled=[...urls].sort(()=>Math.random()-.5);
      return shuffled.map((src,i)=>({ id:`img_${i+1}`, name:pick(FNAMES), gender:"women", age:rnd(18,40), tags:pickMany(TAGS,3), desc:pick(DESCS), photos:[src]}));
    }
    function loadOrGeneratePersonas(){
      try{ const raw=localStorage.getItem(PERSONA_CACHE_KEY); if(raw){const p=JSON.parse(raw); if(Array.isArray(p)&&p.length) return p;} }catch(e){}
      const base = PERSONA_IMAGES.length ? PERSONA_IMAGES : FALLBACK_IMAGES;
      const generated = buildPersonasFromImages(base);
      try{ localStorage.setItem(PERSONA_CACHE_KEY, JSON.stringify(generated)); }catch(e){}
      return generated;
    }

    /* ==================== State & DOM helpers ==================== */
    const state = {
      step:"landing",
      filters:{ gender:"women", ageMin:18, ageMax:60, city:"" },
      pool:[], idx:0,
      likesLeft:LIKE_LIMIT, superLeft:SUPERLIKE_LIMIT,
      busy:false,
    };
    let PERSONAS = loadOrGeneratePersonas();
    const $ = s => document.querySelector(s);
    const el = (tag, props={}, children=[])=>{
      const n=document.createElement(tag);
      Object.entries(props).forEach(([k,v])=>{
        if(k==="class") n.className=v;
        else if(k==="text") n.textContent=v;
        else if(k.startsWith("on") && typeof v==="function") n.addEventListener(k.slice(2).toLowerCase(), v, {passive:true});
        else n.setAttribute(k,v);
      });
      (Array.isArray(children)?children:[children]).filter(Boolean).forEach(c=>n.appendChild(c));
      return n;
    };

    function openLink(url){
      if (tg){
        if (/^(tg:|https?:\/\/t\.me\/)/i.test(url)) { tg.openTelegramLink(url); return; }
        tg.openLink(url,{try_instant_view:false}); return;
      }
      window.open(url,"_blank");
    }

    /* ==================== UI ==================== */
    function renderBrand(){
      const wrap = el("div",{class:"brand"});
      const logo = el("img", { src:"./images/image-removebg-preview.png", alt:"Flamme", style:"width:28px;height:28px;object-fit:contain;display:block" });
      wrap.appendChild(logo);
      wrap.appendChild(el("h1",{text:BRAND}));
      return wrap;
    }

    function render(){
      const root = $("#app"); root.innerHTML="";
      root.appendChild(renderBrand());
      if(state.step==="landing") root.appendChild(renderLanding());
      else root.appendChild(renderBrowse());
      ensureModals(root);
    }

    function renderLanding(){
      const card = el("div",{class:"card"}), box  = el("div",{class:"welcome"});
      box.appendChild(el("div",{class:"label",text:"Que recherchez-vous ?"}));
      const genderSel = el("select",{id:"selGender",class:"sel"});
      [["women","Femme"],["men","Homme"],["all","Tout"]].forEach(([v,l])=> genderSel.appendChild(el("option",{value:v,text:l})));
      genderSel.value = state.filters.gender;
      genderSel.onchange = ()=> state.filters.gender = genderSel.value;
      box.appendChild(el("div",{class:"field"}, genderSel));

      box.appendChild(el("div",{class:"label",text:"√Çge"}));
      const row = el("div",{class:"row"});
      const ageMinSel = el("select",{class:"sel"}); for(let a=18;a<=60;a++) ageMinSel.appendChild(el("option",{value:a,text:a})); ageMinSel.value=state.filters.ageMin;
      const ageMaxSel = el("select",{class:"sel"}); for(let a=18;a<=60;a++) ageMaxSel.appendChild(el("option",{value:a,text:a})); ageMaxSel.value=state.filters.ageMax;
      ageMinSel.onchange = ()=>{ state.filters.ageMin = parseInt(ageMinSel.value,10);
        if(state.filters.ageMin > state.filters.ageMax){ state.filters.ageMax = state.filters.ageMin; ageMaxSel.value = String(state.filters.ageMax);} };
      ageMaxSel.onchange = ()=>{ state.filters.ageMax = parseInt(ageMaxSel.value,10);
        if(state.filters.ageMax < state.filters.ageMin){ state.filters.ageMin = state.filters.ageMax; ageMinSel.value = String(state.filters.ageMin);} };
      row.appendChild(el("div",{style:"flex:1"},[ el("div",{class:"label",text:"Entre"}), el("div",{class:"field"}, ageMinSel) ]));
      row.appendChild(el("div",{style:"flex:1"},[ el("div",{class:"label",text:"et"}),     el("div",{class:"field"}, ageMaxSel) ]));
      box.appendChild(row);

      box.appendChild(el("div",{class:"label",text:"Dans quelle ville habitez-vous ?"}));
      const city = el("input",{class:"input",type:"text",placeholder:"Ville (optionnel)"}); city.value=state.filters.city; city.oninput=()=> state.filters.city=city.value.trim();
      box.appendChild(el("div",{class:"field"}, city));

      const cta = el("button",{class:"cta",text:"Voir les c√©libataires", onclick:()=>{
        const g=state.filters.gender, a1=state.filters.ageMin, a2=state.filters.ageMax;
        state.pool = PERSONAS.filter(p => (g==="all"||p.gender===g) && p.age>=a1 && p.age<=a2);
        if(!state.pool.length){ alert("Aucun profil trouv√©. √âlargis les filtres ‚ú®"); return; }
        state.idx=0;
        state.likesLeft = parseInt(localStorage.getItem(likesKey) ?? LIKE_LIMIT, 10);
        state.superLeft = parseInt(localStorage.getItem(superKey) ?? SUPERLIKE_LIMIT, 10);
        incStat('filters', { gender: state.filters.gender, ageMin: state.filters.ageMin, ageMax: state.filters.ageMax, city: state.filters.city });
        state.step="browse"; render(); openRulesModal();
      }});
      box.appendChild(cta);
      box.appendChild(el("p",{class:"hint",text:"3 likes + 1 super-like par compte non cr√©√©."}));

      card.appendChild(box);
      return card;
    }

    function renderBrowse(){
      const card = el("div",{class:"card"});

      const meta = el("div",{class:"meta"},[
        el("div",{class:"count",text:`Likes: ${state.likesLeft} ‚Ä¢ Super-like: ${state.superLeft}`}),
        el("div",{class:"count",text:`${state.filters.city?state.filters.city+" ‚Ä¢ ":""}${labelGender(state.filters.gender)} ‚Ä¢ ${state.filters.ageMin}-${state.filters.ageMax} ans`})
      ]);
      card.appendChild(meta);

      const p = currentPersona();
      const mediaWrap = el("div",{class:"persona-box"});
      mediaWrap.appendChild(el("img",{class:"persona-img",src:p.photos[0],alt:p.name,loading:"eager"}));
      card.appendChild(mediaWrap);

      const body = el("div",{class:"persona-body"});
      body.appendChild(el("div",{class:"title",text:`${p.name} ‚Ä¢ ${p.age}`}));
      body.appendChild(el("div",{class:"tags"}, p.tags.map(t=>el("span",{class:"tag",text:t}))));
      body.appendChild(el("div",{class:"desc",text:p.desc}));
      card.appendChild(body);

      const actions = el("div",{class:"actions"});
      const bPass  = el("button",{class:"btn btn-pass", text:"PASS", onclick:()=>!state.busy && doPass()});
      const bSLike = el("button",{class:"btn btn-slike",text:"SUPER LIKE", onclick:()=>!state.busy && superLike()}); // laissons cliquable m√™me √† 0
      const bLike  = el("button",{class:"btn btn-like", text:"LIKE", onclick:()=>!state.busy && like()});
      actions.append(bPass,bSLike,bLike);
      card.appendChild(actions);

      return card;
    }

    /* ==================== Logique ==================== */
    function labelGender(g){ return g==="women"?"Femmes":g==="men"?"Hommes":"Tous"; }
    function currentPersona(){ return state.pool[state.idx % state.pool.length]; }
    function bumpGuard(){ state.busy=true; setTimeout(()=>state.busy=false,140); }
    function nextPersona(){ bumpGuard(); state.idx=(state.idx+1)%state.pool.length; incStat('profiles_seen'); render(); }

    function doPass(){
      incStat('pass', { id: currentPersona().id });
      nextPersona();
    }

    function like(){
      if(state.likesLeft<=0){ openNoLikesModal(); incStat('like_blocked'); return; }
      const p = currentPersona();
      state.likesLeft -= 1; localStorage.setItem(likesKey, state.likesLeft);
      incStat('like', { id: p.id });
      nextPersona();
      if(state.likesLeft<=0) openNoLikesModal();
    }

    function superLike(){
      const p = currentPersona();
      if (state.superLeft > 0) {
        state.superLeft -= 1; localStorage.setItem(superKey, state.superLeft);
        incStat('super_like', { id: p.id });
      } else {
        // super-like d√©j√† utilis√©, on r√©-ouvre quand m√™me la popup Match
        incStat('super_like_reopen', { id: p.id });
      }
      bumpGuard();
      openMatchModal(p);
      incStat('match', { id: p.id });
    }

    /* ==================== Modals (r√®gles / like / match / admin) ==================== */
    function ensureModals(root){
      // R√®gles / onboarding
      root.appendChild(el("div",{class:"modal",id:"m_rules"},
        el("div",{class:"modal-card hot"},[
          el("div",{class:"headline",text:"üî• Rappel rapide"}),
          el("div",{text:"Tu d√©marres avec 3 Likes ‚ù§Ô∏è et 1 Super-Like ‚ú®. Tu pourras cr√©er ton compte plus tard pour obtenir des likes bonus imm√©diatement."}),
          el("div",{class:"modal-actions"},[
            el("button",{class:"btn-ghost",text:"D‚Äôaccord",onclick:()=>closeModal("#m_rules")})
          ])
        ])
      ));

      // Plus de likes
      root.appendChild(el("div",{class:"modal",id:"m_nolikes"},
        el("div",{class:"modal-card hot"},[
          el("div",{class:"headline",text:"üíî Plus de likes"}),
          el("div",{text:"Tu as √©puis√© tes 3 likes. Cr√©e ton compte maintenant pour d√©bloquer des likes suppl√©mentaires."}),
          el("div",{class:"modal-actions"},[
            el("a",{href:"#",class:"btn-primary pulse",text:"S‚Äôinscrire et obtenir + de likes",
              onclick:(e)=>{e.preventDefault(); incStat('cta_more'); openLink(MORE_LIKES_URL); }})
          ])
        ])
      ));

      // Match
      root.appendChild(el("div",{class:"modal",id:"m_match"},
        el("div",{class:"modal-card hot"},[
          el("div",{class:"headline",text:"üéâ Match obtenu !"}),
          el("div",{class:"modal-hero"},
            el("img",{id:"matchImg",src:"",alt:"Match",style:"width:100%;display:block"})
          ),
          el("div",{style:"font-weight:800;margin-top:2px"},[
            document.createTextNode("Vous avez match√© avec "),
            el("span",{id:"matchName",text:"cette personne"}),
            document.createTextNode(" üíû")
          ]),
          el("div",{class:"modal-actions"},[
            el("a",{href:"#",class:"btn-primary pulse",text:"Discuter maintenant",
              onclick:(e)=>{e.preventDefault(); incStat('cta_chat'); openLink(MATCH_CHAT_URL); }})
          ])
        ])
      ));

      // Admin
      root.appendChild(el("div",{class:"modal",id:"m_admin"},
        el("div",{class:"modal-card"},[
          el("div",{class:"headline",text:"üìä Panneau admin (local)"}),
          el("div",{id:"adminBody"}),
          el("div",{class:"modal-actions"},[
            el("button",{class:"btn-ghost",text:"Export CSV",onclick:()=>exportCSV()}),
            el("button",{class:"btn-ghost",text:"Export JSON",onclick:()=>exportJSON()}),
            el("button",{class:"btn-ghost",text:"R√©initialiser",onclick:()=>{ if(confirm('R√©initialiser les stats locales ?')){ resetStats(); } }}),
            el("button",{class:"btn-primary",text:"Fermer",onclick:()=>closeModal("#m_admin")}),
          ])
        ])
      ));
    }

    function renderAdmin(){
      const s = loadStats();
      const b = $("#adminBody"); if(!b) return;
      const t = s.totals, d = s.byDay[todayStr()] || {};
      b.innerHTML = "";
      b.appendChild(el("div",{class:"admin-grid"},[
        cardStat("üë• Sessions (appareil)", s.sessions, d.sessions||0),
        cardStat("ü™ü Ouvertures", t.opens, d.opens||0),
        cardStat("üñºÔ∏è Profils vus", t.profiles_seen, d.profiles_seen||0),
        cardStat("üëç Likes", t.like, d.like||0),
        cardStat("‚ú® Super-likes", t.super_like, d.super_like||0),
        cardStat("üéâ Matchs", t.match, d.match||0),
        cardStat("‚Ü©Ô∏è Pass", t.pass, d.pass||0),
        cardStat("‚û°Ô∏è CTA +Likes", t.cta_more, d.cta_more||0),
        cardStat("üí¨ CTA Discuter", t.cta_chat, d.cta_chat||0),
      ]));
      const info = el("p",{text:"Note : ces statistiques sont stock√©es uniquement en local sur cet appareil (localStorage). Pour agr√©ger plusieurs utilisateurs, il faut un backend."});
      info.style.color="#6b7280"; info.style.fontSize="12px"; info.style.marginTop="8px";
      b.appendChild(info);
    }
    function cardStat(label, total, today){
      const box = el("div",{class:"stat"});
      box.appendChild(el("div",{text:label}));
      box.appendChild(el("small",{text:`Total : ${total} ‚Ä¢ Aujourd‚Äôhui : ${today}`}));
      return box;
    }

    function openModal(sel){ const m=$(sel); if(m) { renderAdmin(); m.classList.add("open"); } }
    function closeModal(sel){ const m=$(sel); if(m) m.classList.remove("open"); }
    function openRulesModal(){ openModal("#m_rules"); }
    function openNoLikesModal(){ openModal("#m_nolikes"); }
    function openMatchModal(p){
      const img = $("#matchImg"); const nm = $("#matchName");
      if (img) img.src = p.photos[0];
      if (nm)  nm.textContent = p.name;
      const m=$("#m_match"); if(m) m.classList.add("open");
    }

    /* ==================== Boot ==================== */
    render();
    document.getElementById('btnAdmin').addEventListener('click', ()=> openModal("#m_admin"));
  </script>
</body>
</html>
