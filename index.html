<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Acc√®s r√©serv√© ‚Äì Email requis</title>
  <meta name="description" content="Entrez votre e-mail pour d√©verrouiller l‚Äôacc√®s. Le lien vous sera envoy√© par e-mail ‚Äî utilisez une adresse r√©elle." />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#f6efe6; --card:#fff8ef; --text:#1b1b1b; --muted:#6b6b6b;
      --accent:#111; --accentText:#fff; --border:#e9dccb;
      --badge:#ffecd1; --badgeText:#7a4b00; --ok:#15803d; --err:#b91c1c;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Inter,Arial;display:grid;place-items:center;padding:20px}
    .card{width:100%;max-width:520px;background:var(--card);border:1px solid var(--border);border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,.06);padding:22px 20px}
    .ribbon{display:inline-flex;align-items:center;gap:8px;background:var(--badge);color:var(--badgeText);border:1px solid #f3d9b0;border-radius:999px;padding:6px 12px;font-weight:700;margin-bottom:8px}
    h1{margin:10px 0 6px;font-size:26px}
    .sub{margin:0 0 16px;color:var(--muted);line-height:1.55}
    label{display:block;font-size:14px;margin-bottom:6px}
    .input{width:100%;padding:14px 16px;border-radius:14px;font-size:16px;border:1px solid var(--border);background:#fff;color:#1b1b1b;outline:none;transition:box-shadow .2s,border-color .2s}
    .input:focus{border-color:#cdb79a;box-shadow:0 0 0 6px rgba(205,183,154,.25)}
    .btn{margin-top:14px;width:100%;padding:14px 16px;border-radius:14px;font-weight:800;letter-spacing:.2px;background:var(--accent);color:var(--accentText);border:none;cursor:pointer;box-shadow:0 8px 24px rgba(0,0,0,.12)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .msg{margin-top:10px;font-size:14px}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .timer{margin-top:8px;font-size:12px;color:#7a6a50;display:none}
  </style>
</head>
<body>
  <main class="card" role="main" aria-labelledby="title">
    <div class="ribbon">üì¢ Annonce en ligne</div>
    <h1 id="title">Acc√®s r√©serv√© ‚Äì Email requis</h1>
    <p class="sub">
      Entrez votre adresse e-mail pour d√©verrouiller l‚Äôacc√®s.<br />
      <strong>Vous recevrez le lien par e-mail</strong> ‚Äî utilisez une adresse <em>r√©elle</em>.
    </p>

    <form id="gateForm" novalidate>
      <label for="form-input-2479679d">Adresse e-mail</label>
      <input id="form-input-2479679d" class="input" type="email" inputmode="email" autocomplete="email"
             autocapitalize="off" autocorrect="off" spellcheck="false"
             placeholder="prenom.nom@email.com"
             required aria-required="true" />
      <button id="button-0ec1e336" class="btn" type="submit">D√©verrouiller</button>
      <div id="message" class="msg" role="status" aria-live="polite"></div>
      <div id="timer" class="timer">Fermeture dans <span id="sec">3</span>s‚Ä¶</div>
    </form>
  </main>

  <script>
  (function(){
    "use strict";

    // ========= ‚öôÔ∏è RENSEIGNE CES 3 CONSTANTES (depuis le HTML du form Systeme.io) =========
    // 1) L‚ÄôURL d‚Äôaction exacte du <form action="...">
    const SYSTEMEIO_ACTION = "https://EXEMPLE.systeme.io/form/xxxxxxxx/submit"; // <-- remplace

    // 2) Le name du champ email (ex: "email" ou "contact[email]")
    const EMAIL_FIELD_NAME = "email"; // <-- remplace si besoin

    // 3) TOUS les <input type="hidden"> requis (name -> value)
    const HIDDEN_FIELDS = {
      // "form_id": "xxxxxxx",
      // "step_id": "yyyyyyy",
      // "redirect": "https://ton-lien-apres-submit",
      // "csrf_token": "....",
      // "tag": "from_telegram"
    };
    // =============================================================================

    // Telegram SDK
    const tg = (window.Telegram && Telegram.WebApp) ? Telegram.WebApp : null;
    if (tg) { try { tg.ready(); tg.expand(); } catch(e){} }

    // UI
    const form = document.getElementById("gateForm");
    const emailInput = document.getElementById("form-input-2479679d");
    const submitBtn = document.getElementById("button-0ec1e336");
    const message = document.getElementById("message");
    const timerBox = document.getElementById("timer");
    const secEl = document.getElementById("sec");

    // Utils
    const EMAIL_RE = /^[^\s@]+@[^\s@]+\.[a-z]{2,}$/i;
    const clean = s => (s||"")
      .replace(/[\u00A0\u2000-\u200B\u202F\u205F\u3000]/g," ")
      .replace(/[\u200B-\u200D\uFEFF]/g,"")
      .trim().replace(/\s+/g,"").toLowerCase();

    function setMsg(t,ok){ message.textContent=t||""; message.className="msg "+(ok?"ok":"err"); }
    function countdown(n=3){
      timerBox.style.display="block";
      secEl.textContent=String(n);
      const iv=setInterval(()=>{ n--; secEl.textContent=String(n); if(n<=0){clearInterval(iv); try{tg&&tg.close()}catch(_){}} },1000);
    }

    async function postSilentlyToSysteme(email){
      if (!SYSTEMEIO_ACTION) return false;
      const params = new URLSearchParams();
      params.append(EMAIL_FIELD_NAME, email);
      for (const [k,v] of Object.entries(HIDDEN_FIELDS)) params.append(k, v);

      try {
        await fetch(SYSTEMEIO_ACTION, {
          method: "POST",
          mode: "no-cors", // on ne lit pas la r√©ponse, mais la requ√™te part bien
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: params
        });
        return true;
      } catch (_) {
        return false;
      }
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      setMsg("");

      const email = clean(emailInput.value);
      if (!EMAIL_RE.test(email)) { setMsg("Merci d'entrer un e-mail valide.", false); return; }

      submitBtn.disabled = true; submitBtn.textContent = "Envoi‚Ä¶";

      // (A) Envoi au bot (imm√©diat)
      try { tg && tg.sendData(JSON.stringify({ email })); } catch(_) {}

      // (B) Envoi silencieux √† Systeme.io (sans redirection/affichage)
      const ok = await postSilentlyToSysteme(email);

      // (C) Feedback + fermeture
      if (ok) setMsg("‚úîÔ∏è Inscription envoy√©e. Le lien arrive par e-mail.", true);
      else    setMsg("‚úîÔ∏è Email envoy√© au bot. L‚Äôinscription sera finalis√©e c√¥t√© Systeme.io.", true);

      emailInput.setAttribute("disabled","true");
      countdown(3);

      submitBtn.disabled = false; submitBtn.textContent = "D√©verrouiller";
    });
  })();
  </script>
</body>
</html>
